<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Workshop - Codopia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .sparkle { animation: sparkle 2s linear infinite; }
        .float { animation: float 3s ease-in-out infinite; }
        .drag-block {
            cursor: grab;
            transition: all 0.3s ease;
        }
        .drag-block:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .drag-block.dragging {
            cursor: grabbing;
            transform: rotate(5deg) scale(1.1);
            z-index: 1000;
        }
        .drop-zone {
            min-height: 60px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: #8b5cf6;
            background-color: #f3f4f6;
        }
        .code-canvas {
            background: linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(-45deg, #f8fafc 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f8fafc 75%), 
                        linear-gradient(-45deg, transparent 75%, #f8fafc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        /* Collapsible Sidebar Styles */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .sidebar-overlay {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .sidebar-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        /* Optimized Layout for Maximum Space */
        .main-workspace {
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Enhanced Magic Stage */
        .magic-stage-large {
            min-height: 400px;
        }
        
        @media (min-width: 1024px) {
            .magic-stage-large {
                min-height: 500px;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100">
    <!-- Floating Sparkles -->
    <div class="fixed inset-0 pointer-events-none z-10">
        <div class="sparkle absolute top-20 left-10 w-4 h-4 bg-purple-400 rounded-full"></div>
        <div class="sparkle absolute top-40 right-20 w-3 h-3 bg-pink-400 rounded-full" style="animation-delay: 0.5s;"></div>
        <div class="sparkle absolute bottom-40 left-20 w-2 h-2 bg-blue-400 rounded-full" style="animation-delay: 1s;"></div>
        <div class="sparkle absolute bottom-20 right-10 w-3 h-3 bg-yellow-400 rounded-full" style="animation-delay: 1.5s;"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Collapsible Lesson Sidebar -->
    <div id="lesson-sidebar" class="sidebar fixed left-0 top-0 h-full w-80 bg-white/95 backdrop-blur-md shadow-2xl z-50 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-purple-700">üßô‚Äç‚ôÇÔ∏è Magic Lessons</h2>
                <button id="close-sidebar" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <div class="space-y-4">
                <div class="lesson-item bg-gradient-to-r from-purple-500 to-pink-500 text-white p-4 rounded-xl cursor-pointer" data-lesson="1">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">Lesson 1: Making the Wizard Move</h3>
                            <p class="text-sm opacity-90">Learn basic movement spells</p>
                        </div>
                        <span class="text-2xl">üßô‚Äç‚ôÇÔ∏è</span>
                    </div>
                </div>
                
                <div class="lesson-item bg-gray-100 text-gray-600 p-4 rounded-xl cursor-pointer" data-lesson="2">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">Lesson 2: Casting Spell Patterns</h3>
                            <p class="text-sm">Create magical sequences</p>
                        </div>
                        <span class="text-2xl">üîÆ</span>
                    </div>
                </div>
                
                <div class="lesson-item bg-gray-100 text-gray-600 p-4 rounded-xl cursor-pointer" data-lesson="3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">Lesson 3: Magical Decisions</h3>
                            <p class="text-sm">If-then magic spells</p>
                        </div>
                        <span class="text-2xl">‚ö°</span>
                    </div>
                </div>
                
                <div class="lesson-item bg-gray-100 text-gray-600 p-4 rounded-xl cursor-pointer" data-lesson="4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">Lesson 4: Treasure Hunt</h3>
                            <p class="text-sm">Loops and repetition</p>
                        </div>
                        <span class="text-2xl">üíé</span>
                    </div>
                </div>
                
                <div class="lesson-item bg-gray-100 text-gray-600 p-4 rounded-xl cursor-pointer" data-lesson="5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-bold">Lesson 5: Magic Functions</h3>
                            <p class="text-sm">Create your own spells</p>
                        </div>
                        <span class="text-2xl">üåü</span>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 p-4 bg-purple-50 rounded-xl">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-purple-700 font-semibold">Progress</span>
                    <span class="text-purple-600">1/5</span>
                </div>
                <div class="w-full bg-purple-200 rounded-full h-3">
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full" style="width: 20%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <button id="open-sidebar" class="lg:hidden bg-purple-100 hover:bg-purple-200 p-2 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <button id="open-sidebar-desktop" class="hidden lg:block bg-purple-100 hover:bg-purple-200 p-2 rounded-lg transition-colors">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <a href="/dashboard" class="flex items-center space-x-2 text-gray-600 hover:text-purple-600">
                        <span>‚Üê</span>
                        <span>Back to Dashboard</span>
                    </a>
                    <div class="h-6 w-px bg-gray-300"></div>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white text-lg">üé®</span>
                        </div>
                        <span class="text-xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Magic Workshop</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-purple-100 px-3 py-1 rounded-full">
                        <span class="text-purple-600 font-semibold">{{ child_name }}</span>
                        <span class="text-purple-500">‚Ä¢</span>
                        <span class="text-purple-600">Age {{ child_age }}</span>
                    </div>
                    <button id="sparkle-btn" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full hover:from-purple-600 hover:to-pink-600 transition-all">
                        ‚ú® Ask Professor Sparkle
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Workspace - Optimized for Maximum Space -->
    <div id="main-workspace" class="main-workspace max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Coding Blocks Palette - Enhanced -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <h2 class="text-2xl font-bold text-purple-700 mb-6">üé® Magic Spell Blocks</h2>
                
                <div class="space-y-4">
                    <!-- Movement Blocks -->
                    <div class="block-category">
                        <h3 class="text-lg font-semibold text-purple-600 mb-3">Movement Spells</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="drag-block bg-gradient-to-r from-blue-400 to-blue-500 text-white p-3 rounded-lg flex items-center space-x-2" draggable="true" data-block-type="move">
                                <span class="text-xl">‚û°Ô∏è</span>
                                <span class="font-semibold text-sm">Move Right</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-blue-400 to-blue-500 text-white p-3 rounded-lg flex items-center space-x-2" draggable="true" data-block-type="move">
                                <span class="text-xl">‚¨ÖÔ∏è</span>
                                <span class="font-semibold text-sm">Move Left</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-blue-400 to-blue-500 text-white p-3 rounded-lg flex items-center space-x-2" draggable="true" data-block-type="move">
                                <span class="text-xl">‚¨ÜÔ∏è</span>
                                <span class="font-semibold text-sm">Move Up</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-blue-400 to-blue-500 text-white p-3 rounded-lg flex items-center space-x-2" draggable="true" data-block-type="move">
                                <span class="text-xl">‚¨áÔ∏è</span>
                                <span class="font-semibold text-sm">Move Down</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Blocks -->
                    <div class="block-category">
                        <h3 class="text-lg font-semibold text-purple-600 mb-3">Action Spells</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="drag-block bg-gradient-to-r from-green-400 to-green-500 text-white p-3 rounded-lg flex items-center space-x-3" draggable="true" data-block-type="action">
                                <span class="text-xl">‚ú®</span>
                                <span class="font-semibold">Cast Sparkle</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-green-400 to-green-500 text-white p-3 rounded-lg flex items-center space-x-3" draggable="true" data-block-type="action">
                                <span class="text-xl">üîÆ</span>
                                <span class="font-semibold">Magic Orb</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-green-400 to-green-500 text-white p-3 rounded-lg flex items-center space-x-3" draggable="true" data-block-type="action">
                                <span class="text-xl">üåü</span>
                                <span class="font-semibold">Star Burst</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Control Blocks -->
                    <div class="block-category">
                        <h3 class="text-lg font-semibold text-purple-600 mb-3">Control Spells</h3>
                        <div class="grid grid-cols-1 gap-2">
                            <div class="drag-block bg-gradient-to-r from-orange-400 to-orange-500 text-white p-3 rounded-lg flex items-center space-x-3" draggable="true" data-block-type="control">
                                <span class="text-xl">üîÑ</span>
                                <span class="font-semibold">Repeat 3 times</span>
                            </div>
                            <div class="drag-block bg-gradient-to-r from-orange-400 to-orange-500 text-white p-3 rounded-lg flex items-center space-x-3" draggable="true" data-block-type="control">
                                <span class="text-xl">‚è±Ô∏è</span>
                                <span class="font-semibold">Wait 1 second</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Canvas - Enhanced -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-purple-700">üßô‚Äç‚ôÇÔ∏è Spell Canvas</h2>
                    <div class="flex space-x-2">
                        <button id="run-code" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-lg hover:from-green-600 hover:to-green-700 transition-all">
                            ‚ñ∂Ô∏è Cast Spell
                        </button>
                        <button id="clear-code" class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-lg hover:from-red-600 hover:to-red-700 transition-all">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
                
                <div id="code-canvas" class="code-canvas min-h-96 p-4 border-2 border-dashed border-purple-300 rounded-xl">
                    <div class="text-center text-purple-400 py-8">
                        <span class="text-4xl block mb-2">üéØ</span>
                        <p class="text-lg">Drag spell blocks here to create your magic!</p>
                        <p class="text-sm mt-2">Start with a movement spell to make the wizard move</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Magic Stage - Maximum Size -->
        <div class="mt-8 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-purple-700">üé≠ Magic Stage</h2>
                <div class="flex items-center space-x-4">
                    <button id="reset-stage" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all">
                        üîÑ Reset
                    </button>
                    <div class="flex items-center space-x-4 text-sm">
                        <span class="text-purple-600">‚≠ê Magic Points: <span id="magic-points">0</span></span>
                        <span class="text-purple-600">üèÜ Achievements: <span id="achievements">0</span></span>
                    </div>
                </div>
            </div>
            
            <div id="magic-stage" class="magic-stage-large relative bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900 rounded-xl overflow-hidden">
                <!-- Stars background -->
                <div class="absolute inset-0">
                    <div class="absolute top-4 left-8 w-1 h-1 bg-white rounded-full sparkle"></div>
                    <div class="absolute top-12 right-12 w-1 h-1 bg-white rounded-full sparkle" style="animation-delay: 0.5s;"></div>
                    <div class="absolute bottom-8 left-16 w-1 h-1 bg-white rounded-full sparkle" style="animation-delay: 1s;"></div>
                    <div class="absolute bottom-16 right-8 w-1 h-1 bg-white rounded-full sparkle" style="animation-delay: 1.5s;"></div>
                    <div class="absolute top-20 left-1/2 w-1 h-1 bg-white rounded-full sparkle" style="animation-delay: 2s;"></div>
                    <div class="absolute bottom-32 right-1/3 w-1 h-1 bg-white rounded-full sparkle" style="animation-delay: 2.5s;"></div>
                </div>
                
                <!-- Wizard Character -->
                <div id="wizard" class="absolute bottom-4 left-4 text-4xl transition-all duration-1000 ease-in-out float">
                    üßô‚Äç‚ôÇÔ∏è
                </div>
                
                <!-- Magic Effects Container -->
                <div id="magic-effects" class="absolute inset-0 pointer-events-none"></div>
            </div>
            
            <div class="mt-4 text-center text-purple-600">
                <p class="text-lg font-semibold">Complete the lesson to unlock the next magical adventure!</p>
            </div>
        </div>
    </div>

    <!-- Professor Sparkle Modal -->
    <div id="sparkle-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-96 flex flex-col">
            <div class="flex items-center justify-between p-6 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                        <span class="text-white text-2xl">‚ú®</span>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-purple-700">Professor Sparkle</h3>
                        <p class="text-purple-500 text-sm">Your magical coding tutor</p>
                    </div>
                </div>
                <button id="close-sparkle" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
            </div>
            
            <div id="sparkle-chat" class="flex-1 p-6 overflow-y-auto">
                <div class="sparkle-message bg-white mr-8 rounded-lg p-3 mb-3">
                    <p class="text-purple-700">‚ú® Hello there, young wizard! I'm Professor Sparkle, and I'm here to help you learn the magical art of coding! What would you like to know about creating spells with blocks?</p>
                </div>
            </div>
            
            <div class="p-6 border-t">
                <div class="flex space-x-3">
                    <input id="sparkle-input" type="text" placeholder="Ask Professor Sparkle anything about magic coding..." class="flex-1 px-4 py-2 border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <button id="send-sparkle" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-2 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all">
                        Send
                    </button>
                    <button id="voice-sparkle" class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-indigo-600 transition-all">
                        üé§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/sparkle_integration.js"></script>
    <script>
        let codeBlocks = [];
        let wizardPosition = { x: 16, y: 16 };
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeDragAndDrop();
            initializeProfessorSparkle();
            initializeMagicStage();
            initializeSidebar();
            
            // Event listeners for buttons
            document.getElementById('run-code').addEventListener('click', executeCode);
            document.getElementById('clear-code').addEventListener('click', clearCode);
            document.getElementById('reset-stage').addEventListener('click', resetStage);
        });
        
        // Sidebar functionality
        function initializeSidebar() {
            const openSidebarBtn = document.getElementById('open-sidebar');
            const openSidebarDesktopBtn = document.getElementById('open-sidebar-desktop');
            const closeSidebarBtn = document.getElementById('close-sidebar');
            const sidebar = document.getElementById('lesson-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            function openSidebar() {
                sidebar.classList.add('open');
                overlay.classList.add('open');
            }
            
            function closeSidebar() {
                sidebar.classList.remove('open');
                overlay.classList.remove('open');
            }
            
            openSidebarBtn.addEventListener('click', openSidebar);
            openSidebarDesktopBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            overlay.addEventListener('click', closeSidebar);
            
            // Close sidebar when lesson is selected
            const lessonItems = document.querySelectorAll('.lesson-item');
            lessonItems.forEach(item => {
                item.addEventListener('click', () => {
                    closeSidebar();
                    // Add lesson selection logic here
                });
            });
        }
        
        // Rest of the JavaScript functionality remains the same...
        function initializeDragAndDrop() {
            const dragBlocks = document.querySelectorAll('.drag-block');
            const codeCanvas = document.getElementById('code-canvas');
            
            dragBlocks.forEach(block => {
                block.addEventListener('dragstart', handleDragStart);
                block.addEventListener('dragend', handleDragEnd);
            });
            
            codeCanvas.addEventListener('dragover', handleDragOver);
            codeCanvas.addEventListener('drop', handleDrop);
        }
        
        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const blockHTML = e.dataTransfer.getData('text/html');
            const canvas = document.getElementById('code-canvas');
            
            // Clear placeholder if this is the first block
            if (codeBlocks.length === 0) {
                canvas.innerHTML = '';
            }
            
            // Create new block element
            const blockElement = document.createElement('div');
            blockElement.innerHTML = blockHTML;
            const newBlock = blockElement.firstChild;
            newBlock.classList.remove('dragging');
            newBlock.classList.add('mb-2');
            
            canvas.appendChild(newBlock);
            codeBlocks.push(newBlock);
            
            // Check for lesson completion
            checkLessonCompletion();
        }
        
        function executeCode() {
            const wizard = document.getElementById('wizard');
            let delay = 0;
            
            codeBlocks.forEach((block, index) => {
                setTimeout(() => {
                    const blockText = block.textContent.trim();
                    
                    if (blockText.includes('Move Right')) {
                        moveWizard('right');
                    } else if (blockText.includes('Move Left')) {
                        moveWizard('left');
                    } else if (blockText.includes('Move Up')) {
                        moveWizard('up');
                    } else if (blockText.includes('Move Down')) {
                        moveWizard('down');
                    } else if (blockText.includes('Cast Sparkle')) {
                        createMagicEffect('sparkle');
                    } else if (blockText.includes('Magic Orb')) {
                        createMagicEffect('orb');
                    } else if (blockText.includes('Star Burst')) {
                        createMagicEffect('star');
                    }
                }, delay);
                
                delay += 1000; // 1 second delay between each action
            });
        }
        
        function moveWizard(direction) {
            const wizard = document.getElementById('wizard');
            const stage = document.getElementById('magic-stage');
            const stageRect = stage.getBoundingClientRect();
            const wizardRect = wizard.getBoundingClientRect();
            
            const moveDistance = 50;
            
            switch(direction) {
                case 'right':
                    if (wizardPosition.x + moveDistance < stageRect.width - 60) {
                        wizardPosition.x += moveDistance;
                    }
                    break;
                case 'left':
                    if (wizardPosition.x - moveDistance > 0) {
                        wizardPosition.x -= moveDistance;
                    }
                    break;
                case 'up':
                    if (wizardPosition.y + moveDistance < stageRect.height - 60) {
                        wizardPosition.y += moveDistance;
                    }
                    break;
                case 'down':
                    if (wizardPosition.y - moveDistance > 0) {
                        wizardPosition.y -= moveDistance;
                    }
                    break;
            }
            
            wizard.style.left = wizardPosition.x + 'px';
            wizard.style.bottom = wizardPosition.y + 'px';
        }
        
        function createMagicEffect(effectType) {
            const magicEffects = document.getElementById('magic-effects');
            const effect = document.createElement('div');
            
            effect.className = 'absolute text-2xl pointer-events-none';
            effect.style.left = (wizardPosition.x + 20) + 'px';
            effect.style.bottom = (wizardPosition.y + 20) + 'px';
            
            if (effectType.includes('sparkle')) {
                effect.innerHTML = '‚ú®';
                effect.className += ' sparkle';
            } else if (effectType.includes('orb')) {
                effect.innerHTML = 'üîÆ';
                effect.className += ' float';
            } else if (effectType.includes('star')) {
                effect.innerHTML = 'üåü';
                effect.className += ' sparkle';
            }
            
            magicEffects.appendChild(effect);
            
            // Remove effect after animation
            setTimeout(() => {
                effect.remove();
            }, 2000);
        }
        
        function clearCode() {
            const canvas = document.getElementById('code-canvas');
            canvas.innerHTML = `
                <div class="text-center text-purple-400 py-8">
                    <span class="text-4xl block mb-2">üéØ</span>
                    <p class="text-lg">Drag spell blocks here to create your magic!</p>
                    <p class="text-sm mt-2">Start with a movement spell to make the wizard move</p>
                </div>
            `;
            codeBlocks = [];
        }
        
        function resetStage() {
            const wizard = document.getElementById('wizard');
            const magicEffects = document.getElementById('magic-effects');
            
            wizardPosition = { x: 16, y: 16 };
            wizard.style.left = '16px';
            wizard.style.bottom = '16px';
            magicEffects.innerHTML = '';
        }
        
        function awardMagicPoints(points) {
            const magicPointsEl = document.getElementById('magic-points');
            const currentPoints = parseInt(magicPointsEl.textContent);
            magicPointsEl.textContent = currentPoints + points;
        }
        
        function checkLessonCompletion() {
            if (codeBlocks.length >= 3) {
                showSparkleMessage("üéâ Fantastic! You've completed your first magical spell! You're ready for the next lesson!");
                awardMagicPoints(50);
                
                // Update achievements
                const achievementsEl = document.getElementById('achievements');
                achievementsEl.textContent = parseInt(achievementsEl.textContent) + 1;
                
                // Unlock next lesson (visual feedback)
                setTimeout(() => {
                    const nextLesson = document.querySelector('[data-lesson="2"]');
                    if (nextLesson) {
                        nextLesson.classList.remove('bg-gray-100', 'text-gray-600');
                        nextLesson.classList.add('bg-gradient-to-r', 'from-purple-400', 'to-pink-400', 'text-white');
                    }
                }, 1000);
            }
        }
        
        // Professor Sparkle Integration
        function initializeProfessorSparkle() {
            const sparkleBtn = document.getElementById('sparkle-btn');
            const sparkleModal = document.getElementById('sparkle-modal');
            const closeSparkle = document.getElementById('close-sparkle');
            const sendSparkle = document.getElementById('send-sparkle');
            const sparkleInput = document.getElementById('sparkle-input');
            const voiceSparkle = document.getElementById('voice-sparkle');
            
            sparkleBtn.addEventListener('click', () => {
                sparkleModal.classList.remove('hidden');
            });
            
            closeSparkle.addEventListener('click', () => {
                sparkleModal.classList.add('hidden');
            });
            
            sendSparkle.addEventListener('click', sendMessageToSparkle);
            sparkleInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessageToSparkle();
                }
            });
            
            voiceSparkle.addEventListener('click', startVoiceChat);
        }
        
        function sendMessageToSparkle() {
            const input = document.getElementById('sparkle-input');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage(message, 'user');
                input.value = '';
                
                // Simulate Professor Sparkle response
                setTimeout(() => {
                    const response = generateSparkleResponse(message);
                    addChatMessage(response, 'sparkle');
                }, 1000);
            }
        }
        
        function addChatMessage(message, sender) {
            const chat = document.getElementById('sparkle-chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = `sparkle-message ${sender === 'user' ? 'bg-purple-100 ml-8' : 'bg-white mr-8'} rounded-lg p-3 mb-3`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<p class="text-purple-800">${message}</p>`;
            } else {
                messageDiv.innerHTML = `<p class="text-purple-700">‚ú® ${message}</p>`;
            }
            
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function generateSparkleResponse(message) {
            const responses = [
                "That's a wonderful question! In the Magic Workshop, we use visual blocks to create spells. Try dragging a movement block to make the wizard move!",
                "Great thinking! Remember, coding is like casting spells - you need to put the right blocks in the right order to make magic happen!",
                "I love your curiosity! Each block represents a different type of magic. Movement blocks make things move, action blocks create effects, and control blocks help you repeat spells!",
                "Excellent! You're learning the fundamental concepts of programming through magic. Keep experimenting with different combinations of blocks!",
                "That's the spirit of a true wizard! Don't be afraid to try different combinations - that's how we discover new magical possibilities!"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function startVoiceChat() {
            // Placeholder for voice integration
            showSparkleMessage("üé§ Voice chat with Professor Sparkle is coming soon! For now, you can type your questions and I'll help you learn magic coding!");
        }
        
        function showSparkleMessage(message) {
            const sparkleModal = document.getElementById('sparkle-modal');
            sparkleModal.classList.remove('hidden');
            addChatMessage(message, 'sparkle');
        }
        
        function initializeMagicStage() {
            // Add some initial sparkle effects
            setTimeout(() => {
                createRandomSparkles();
            }, 2000);
        }
        
        function createRandomSparkles() {
            const stage = document.getElementById('magic-stage');
            const sparkle = document.createElement('div');
            sparkle.className = 'absolute text-yellow-300 text-sm sparkle';
            sparkle.innerHTML = '‚ú®';
            sparkle.style.left = Math.random() * 300 + 'px';
            sparkle.style.top = Math.random() * 200 + 'px';
            
            stage.appendChild(sparkle);
            
            setTimeout(() => {
                sparkle.remove();
            }, 2000);
            
            // Create more sparkles randomly
            setTimeout(createRandomSparkles, Math.random() * 5000 + 3000);
        }
    </script>
</body>
</html>

